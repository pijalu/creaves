<h1>Nouvelle réception</h1>

<%= formFor(animal, {action: animalsPath(), method: "POST"}) { %>
<div class="stepwizard">
    <div class="stepwizard-row setup-panel">
        <div class="stepwizard-step">
            <a href="#step-0" type="button" class="btn btn-primary btn-circle">0</a>
            <p>Étape 0: Nombre d'animaux</p>
        </div>
        <div class="stepwizard-step">
            <a href="#step-1" type="button" class="btn btn-default btn-circle disabled" >1</a>
            <p>Étape 1: Remplir les informations sur l'animal</p>
        </div>
        <div class="stepwizard-step">
            <a href="#step-2" type="button" class="btn btn-default btn-circle disabled">2</a>
            <p>Étape 2: Remplir des informations sur la découverte</p>
        </div>
        <div class="stepwizard-step">
            <a href="#step-3" type="button" class="btn btn-default btn-circle disabled">3</a>
            <p>Étape 3: Remplir les informations d'admission</p>
        </div>
    </div>
</div>


<div class="setup-content" id="step-0">
    <div class="form-row">
        <div class="form-group col-md-12">
            <div class="container p-3 my-3 border">
                <label>Nombre d'individus dans cette entrée</label>
                <div class="input-group md-12">
                    <input class="form-control" id="animalcount" name="AnimalCount" required="required" type="number" value="1" min="1" 
                    <%= if (!current_user.Admin) {%>
                    max="15"
                    <% } %>
                    />
                    <script type="text/javascript">
                        console.log("Doing stuff on ", $('#animalcount'));
                        $('#animalcount').on("change", function(){
                            var warned = false;
                            return function() {
                                if (!warned && $('#animalcount').val() >= 5) {
                                    if (confirm("Voulez vous créer plus de 5 animaux?")) {
                                        warned = true;
                                    } else {
                                        $('#animalcount').val(1)
                                    }
                                }
                                console.log("Count=",$('#animalcount').val(),'warned', warned);
                                var multipleAnimals=$('#animalcount').val() !== "1";

                                console.log("Set disabled to", multipleAnimals)
                                $('input[name="Intake.HasWounds"]' ).prop("disabled",multipleAnimals);
                                $('input[name="Intake.HasParasites"]' ).prop("disabled",multipleAnimals);

                                $('input[name="Intake.Parasites"]' ).prop("disabled",multipleAnimals);
                                $('a[name="Intake.ParasitesBtn"]' ).prop("disabled",multipleAnimals);
                            
                                $('input[name="Intake.Wounds"]' ).prop("disabled",multipleAnimals);
                                $('a[name="Intake.WoundsBtn"]' ).prop("disabled",multipleAnimals);

                                $('input[name="Intake.Remarks"]' ).prop("disabled",multipleAnimals);
                                $('a[name="Intake.RemarksBtn"]').prop("disabled",multipleAnimals);
                                
                                if (multipleAnimals) {
                                    $('a[name="Intake.ParasitesBtn"]' ).addClass("disabled");
                                    $('a[name="Intake.WoundsBtn"]' ).addClass("disabled");
                                    $('a[name="Intake.RemarksBtn"]' ).addClass("disabled");

                                    $('div[name="Intake.StateDiv"]' ).addClass("d-none");
                                } else {
                                    $('a[name="Intake.ParasitesBtn"]' ).removeClass("disabled");
                                    $('a[name="Intake.RemarksBtn"]' ).removeClass("disabled");
                                    $('a[name="Intake.WoundsBtn"]' ).removeClass("disabled");

                                    $('div[name="Intake.StateDiv"]' ).removeClass("d-none");
                                }
                            };
                        }());
                    </script>
                </div>
            </div>
            <button class="btn btn-primary nextBtn btn-lg pull-right" type="button" >Suivant</button>
        </div> 
    </div>
</div>

<div class="setup-content" id="step-1">
    <div class="form-row">
        <div class="form-group col-md-12">
                <%= f.SelectTag("AnimaltypeID", {
                    label: "Type",
                    options: selectAnimalTypes, 
                    required:"required"}) %>

                <script>
                if ($("#animal-AnimaltypeID")[0][0].value == "") {
                    $("#animal-AnimaltypeID")[0][0].disabled = true;
                }

                $( "#animal-AnimaltypeID" ).on( "change", function() {
                    var term = $("#animal-AnimaltypeID :selected").text();
                    $.getJSON('/suggestions/animaltype_species', { q: term }, function(data){ 
                        if (data.length > 0 ) {
                            $("#animal-Species").val(data[0]);
                            $( "#animal-Species" ).removeClass("is-invalid")
                        }
                    });
                } );

                $( document ).ready(function(){
                    var term = $("#animal-AnimaltypeID :selected").text();
                    $.getJSON('/suggestions/animaltype_species', { q: term }, function(data){ 
                        if ( data.length > 0 ) {
                            $("#animal-Species").val(data[0]);
                            $( "#animal-Species" ).removeClass("is-invalid")
                        }
                    });    
                });

                </script>

                <%= f.InputTag("Species", {label: "Espèce", required: "required"})%>
                <div id="nativeGroupHint"></div>
                <script>
                $('input[name="Species"]').autoComplete({
                    minChars: 1,
                    source: function(term, response){
                        $.getJSON('/suggestions/animal_species', { q: term }, function(data){ response(data); });
                    }
                });

                $( "#animal-Species" ).on( "change", function() {
                    var term = $("#animal-Species").val();
                    $.getJSON('/suggestions/animal_species', { q: term }, function(data){ 
                        $( "#animal-Species" ).addClass("is-invalid")
                        $( "#nativeGroupHint").html("").removeClass("alert alert-primary")
                        for (var i=0; i < data.length ; i++ ) {
                            if (term === data[i]) {
                                $( "#animal-Species" ).removeClass("is-invalid");
                                $.getJSON('/hint/speciesDetails', { q: term }, function(data){
                                    $( "#nativeGroupHint").html(data[0].indication).addClass("alert alert-primary")
                                });
                                break;
                            } 
                        }
                    });
                } );
                </script>

                <%= f.InputTag("Ring", {label:"Identification", placeholder:"Bague, Puce, Gaines Marquage, Couleurs, ..." }) %>
                <%= f.SelectTag("AnimalageID", {
                    label: "Age",
                    options: selectAnimalages, 
                    required:"required"}) %>
                
                <button class="btn btn-primary prevBtn btn-lg pull-right" type="button" >Précedent</button>
                <button class="btn btn-primary nextBtn btn-lg pull-right" type="button" >Suivant</button>
        </div>
    </div>
</div>
<div class="setup-content" id="step-2">
        <div class="col-xs-12">
            <div class="col-md-12">
                <div class="container p-3 my-3 border">
                    <h4>Découverte</h4>
                    <div class="form-row">  
                        <%= f.InputTag("Discovery.PostalCode", {bootstrap:{form-group-class:"form-group col-md-6"}, label:"Code Postal"}) %>
                        <%= f.InputTag("Discovery.City", {bootstrap:{form-group-class:"form-group col-md-6"}, label:"Ville"}) %>
                    
                        <script>
                        $('input[name="Discovery.PostalCode"]').autoComplete({
                            minChars: 0,
                            cache: 0,
                            source: function(term, response){
                                var city = $('input[name="Discovery.City"]').val();
                                var postalCode = $('input[name="Discovery.PostalCode"]').val();

                                $.getJSON('/suggestions/locality', { r: "postal_code", z: postalCode, l: city }, function(data){ response(data); });
                            }
                        });

                        $('input[name="Discovery.City"]').autoComplete({
                            minChars: 0,
                            cache: 0,
                            source: function(term, response){
                                var postalCode = $('input[name="Discovery.PostalCode"]').val();
                                $.getJSON('/suggestions/locality', { r: "locality", z: postalCode, l: term }, function(data){ response(data); });
                            }
                        });
                        </script>
                    </div>
                    
                    <div class="form-row">
                    <%= f.InputTag("Discovery.Location", {label:"Adresse, lieu précis", placeholder:"Adresse, lieu précis", bootstrap:{form-group-class:"form-group col-md-12"}}) %>
                    <script>
                    $('input[name="Discovery.Location"]').autoComplete({
                        minChars: 1,
                        source: function(term, response){
                            $.getJSON('/suggestions/discovery_location', { q: term }, function(data){ response(data); });
                        }
                    });
                    </script>
                    </div>

                    <div class="form-row">
                        <div class="form-check text-center col-md-12">
                            <div class="form-row">                
                                <%= f.CheckboxTag("Discovery.InGarden", { unchecked: false, label: "Trouvé à l'adresse du découvreur", bootstrap:{form-group-class:"col-md-6 form-check"} }) %>
                                <%= f.CheckboxTag("Discovery.ReturnHabitat", { unchecked: false, label: "Retour à l'habitat", bootstrap:{form-group-class:"col-md-6 form-check"} }) %>
                            </div>
                            <script>
                            $( 'input[name="Discovery.InGarden"]' ).on( "change", function() {
                                if ($( 'input[name="Discovery.InGarden"]' ).is(":checked")) {
                                    console.log("test:", $('input[name="Discovery.Discoverer.PostalCode"]').val() === "", $('input[name="Discovery.Discoverer.City"]').val() === "")

                                    if ($('input[name="Discovery.Discoverer.PostalCode"]').val() === ""
                                        && $('input[name="Discovery.Discoverer.City"]').val() === ""
                                        && $('input[name="Discovery.Discoverer.Address"]').val() === "" ) {
                                            var cp = $('input[name="Discovery.PostalCode"]').val();
                                            var city = $('input[name="Discovery.City"]').val();
                                            var adr = $('input[name="Discovery.Location"]').val();

                                            $('input[name="Discovery.Discoverer.PostalCode"]').val(cp);
                                            $('input[name="Discovery.Discoverer.City"]').val(city);
                                            $('input[name="Discovery.Discoverer.Address"]').val(adr);
                                    }
                                } else {
                                    console.log("found in garden is now false");
                                }
                            } );
                            </script>
                        </div>
                    </div>

                    <div class="form-row">
                    <div class="form-group col-md-12">
                        <label>Date</label>
                        <div class="input-group md-12">
                            <input class=" form-control" id="discodate" name="Discovery.Date" required="required" type="text" value="<%= animal.Discovery.DateFormated() %>"
                            pattern="(?:19|20)[0-9]{2}/(?:(?:0[1-9]|1[0-2])/(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])/(?:30))|(?:(?:0[13578]|1[02])/31)) (0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9])">
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <i class="fa fa-calendar" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script type="text/javascript">
                        $('#discodate').flatpickr({time_24hr:true, enableTime: true, dateFormat:'Y/m/d H:i'});
                    </script>
                    </div>
                </div>

                <div class="container p-3 my-3 border">
                    <h4>Cause d'entrée</h4> 
                    <%= f.SelectTag("Discovery.EntryCauseID", {
                        label: "",
                        options: selectEntryCause,
                        required:"required"}) %>
                    <script type="text/javascript">
                        $('select[name="Discovery.EntryCauseID"]').select2({
                            width: '100%'
                        });
                    </script>

                    <%= f.TextAreaTag("Discovery.Reason", {label:"Détails", rows: 1, class:"col-md-12"}) %>
                    <a class="btn btn-primary" data-toggle="collapse" href="#DiscoveryNote" role="button" aria-expanded="false" aria-controls="collapseExample">
                    Notes
                    </a>
                    <div class="collapse" id="DiscoveryNote">
                        <div class="card card-body">
                            <textarea class="form-control col-md-12" id="animal-Discovery.Note" name="Discovery.Note" rows="10"></textarea>
                        </div>
                    </div>
                </div>

                <div class="container p-3 my-3 border">
                    <h4>Découvreur</h4>
                
                    <div class="form-row">  
                    <%= f.InputTag("Discovery.Discoverer.Firstname", {bootstrap:{form-group-class:"form-group col-md-6"}, label:"Prénom"}) %>
                    <%= f.InputTag("Discovery.Discoverer.Lastname", {bootstrap:{form-group-class:"form-group col-md-6"}, label:"Nom de famille"}) %>
                    </div>
                    <div class="form-row">
                    <%= f.InputTag("Discovery.Discoverer.Address", {bootstrap:{form-group-class:"form-group col-md-12"}, label:"Adresse"}) %>
                    </div>

                    <script>
                        $('input[name="Discovery.Discoverer.Firstname"]').autoComplete({
                            cache: 0,
                            minChars: 1,
                            source: function(term, response){
                                var firstname = $('input[name="Discovery.Discoverer.Firstname"]').val();
                                var lastname = $('input[name="Discovery.Discoverer.Lastname"]').val();
                                var address = $('input[name="Discovery.Discoverer.Address"]').val();

                                $.getJSON('/suggestions/discoverer', { r: "firstname", f: firstname, l:lastname, a: address }, function(data){ 
                                    response(data); 
                                });
                            }
                        });

                        $('input[name="Discovery.Discoverer.Lastname"]').autoComplete({
                            cache: 0,
                            minChars: 1,
                            source: function(term, response){
                                var firstname = $('input[name="Discovery.Discoverer.Firstname"]').val();
                                var lastname = $('input[name="Discovery.Discoverer.Lastname"]').val();
                                var address = $('input[name="Discovery.Discoverer.Address"]').val();

                                $.getJSON('/suggestions/discoverer', { r: "lastname", f: firstname, l:lastname, a: address }, function(data){ 
                                    response(data); 
                                });
                            }
                        });

                        $('input[name="Discovery.Discoverer.Address"]').autoComplete({
                            cache: 0,
                            minChars: 1,
                            source: function(term, response){
                                var firstname = $('input[name="Discovery.Discoverer.Firstname"]').val();
                                var lastname = $('input[name="Discovery.Discoverer.Lastname"]').val();
                                var address = $('input[name="Discovery.Discoverer.Address"]').val();

                                $.getJSON('/suggestions/discoverer', { r: "address", f: firstname, l:lastname, a: address }, function(data){ 
                                    response(data); 
                                });
                            }
                        });
                    </script>

                    <div class="form-row">
                    <%= f.InputTag("Discovery.Discoverer.PostalCode", {bootstrap:{form-group-class:"form-group col-md-4"}, label:"Code Postal"}) %>
                    <%= f.InputTag("Discovery.Discoverer.City", {bootstrap:{form-group-class:"form-group col-md-4"}, label:"Ville"}) %>
                    <%= f.InputTag("Discovery.Discoverer.Country", {bootstrap:{form-group-class:"form-group col-md-4"}, label:"Pays"}) %>
                    <script>
                        $('input[name="Discovery.Discoverer.PostalCode"]').autoComplete({
                                minChars: 0,
                                cache: 0,
                                source: function(term, response){
                                    var city = $('input[name="Discovery.Discoverer.City"]').val();
                                    var postalCode = $('input[name="Discovery.Discoverer.PostalCode"]').val();

                                    $.getJSON('/suggestions/locality', { r: "postal_code", z: postalCode, l: city }, function(data){ response(data); });
                                }
                        });

                        $('input[name="Discovery.Discoverer.City"]').autoComplete({
                            minChars: 0,
                            cache: 0,
                            source: function(term, response){
                                var postalCode = $('input[name="Discovery.Discoverer.PostalCode"]').val();
                                $.getJSON('/suggestions/locality', { r: "locality", z: postalCode, l: term }, function(data){ response(data); });
                            }
                        });

                        $('input[name="Discovery.Discoverer.Country"]').autoComplete({
                            minChars: 1,
                            source: function(term, response){
                                $.getJSON('/suggestions/discoverer_country', { q: term }, function(data){ response(data); });
                            }
                        });
                    </script>

                    </div>
                    <div class="form-row">
                    <%= f.InputTag("Discovery.Discoverer.Email", {placeholder:"toto@creaves.be", bootstrap:{form-group-class:"form-group col-md-6"}, label:"Email"}) %>
                    <%= f.InputTag("Discovery.Discoverer.Phone", {type: "tel", placeholder:"+32470112233", bootstrap:{form-group-class:"form-group col-md-6"}, label:"Téléphone"}) %>
                    </div>


                    <div class="form-row">
                        <%= f.InputTag("Discovery.Discoverer.Donation", {bootstrap:{form-group-class:"form-group col-md-12"}, label:"Don"}) %>
                    </div>

                    <div class="form-row">
                        <%= f.CheckboxTag("Discovery.Discoverer.ReturnRequest", { unchecked: false, label: "Rendre au découvreur", bootstrap:{form-group-class:"form-group col-md-12 form-check text-center"} }) %>
                        <script>
                            $('input[name="Discovery.Discoverer.ReturnRequest"]').on( "change", function() {
                                console.log("Status changed");
                                if ($('input[name="Discovery.Discoverer.ReturnRequest"]').is(":checked")) {
                                    console.log("ReturnRequest is true");
                                    $('input[name="Discovery.ReturnHabitat"]' ).prop( "checked", true );
                                } else {
                                    console.log("ReturnRequest is false");
                                }
                            });
                        </script>
                    </div>


                </div>

                <button class="btn btn-primary prevBtn btn-lg pull-right" type="button" >Précedent</button>
                <button class="btn btn-primary nextBtn btn-lg pull-right" type="button" >Suivant</button>
            </div>
        </div>
    </div>
    <div class="setup-content" id="step-3">
        <div class="col-xs-12">
            <div class="col-md-12">
                <div class="container p-3 my-3 border">
                    <label>Date</label>
                    <div class="input-group md-12">
                        <input class=" form-control" id="intakedate" name="Intake.Date" required="required" type="text" value="<%= animal.Intake.DateFormated() %>"
                        pattern="(?:19|20)[0-9]{2}/(?:(?:0[1-9]|1[0-2])/(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])/(?:30))|(?:(?:0[13578]|1[02])/31)) (0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9])">
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <i class="fa fa-calendar" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                
                    <script type="text/javascript">
                        $('#intakedate').flatpickr({time_24hr:true, enableTime: true, dateFormat:'Y/m/d H:i'});
                        $('input[name="Intake.Date"]').on("change", function() {
                            discoveryDate = $('input[name="Discovery.Date"]').val()
                            intakeDate = $('input[name="Intake.Date"]').val()
    
                            let dd = new Date(discoveryDate).getTime();
                            let id = new Date(intakeDate).getTime();
    
                            if (dd > id) {
                                $('input[name="Intake.Date"]').val(discoveryDate);
                            }
                        });
                    </script>
                </div>

                <div class="container p-3 my-3 border" name="Intake.StateDiv">
                <h4>Etat</h4>


                <div class="form-row d-none">
                    <div class="form-group col-md-6">
                            <%= f.InputTag("Cage") %> 
                    </div>
                    <div class="form-group col-md-6">
                    <%= f.SelectTag("Zone", {
                        label: "Zone",
                        options: selectZone, 
                        required:"required"}) %>
                    </div>
                </div>
                

                <%= f.TextAreaTag("Intake.General", {label:"Etat Général", placeholder: "État de choc, état de maigreur ou d'embonpoint, déshydratation, état de conscience, signe neurologique, hypothermie, bonne forme, suspicion de maladie (virus, bactérie, champignon),...",  rows: 5}) %>

                <div class="col-md-12 form-row">
                    <%= f.CheckboxTag("Intake.HasWounds", {label:"Blessures", unchecked: false, bootstrap:{form-group-class:"form-group col-md-6 form-check text-center"} }) %>
                    <%= f.CheckboxTag("Intake.HasParasites", {label:"Parasites", unchecked: false, bootstrap:{form-group-class:"form-group col-md-6 form-check text-center"} }) %>
                </div>

                <script>
                    $('input[name="Intake.HasWounds"]').on( "change", function() {
                        if ($('input[name="Intake.HasWounds"]').is(":checked")) {
                            $("#Wounds").collapse("show");
                        } else {
                            $("#Wounds").collapse("hide");
                        }
                    });

                    $('input[name="Intake.HasParasites"]').on( "change", function() {
                        if ($('input[name="Intake.HasParasites"]').is(":checked")) {
                            $("#Parasites").collapse("show");
                        } else {
                            $("#Parasites").collapse("hide");
                        }
                    });
                </script>

                <a class="btn btn-primary" name="Intake.WoundsBtn" data-toggle="collapse" href="#Wounds" role="button" aria-expanded="false" aria-controls="collapseExample">
                    l'animal est blessé
                </a>
                <div class="collapse" id="Wounds">
                    <div class="card card-body">
                        <textarea class="form-control col-md-12" id="animal-Intake.Wounds" name="Intake.Wounds" rows="5"></textarea>
                    </div>
                </div>

                <a class="btn btn-primary" name="Intake.ParasitesBtn" data-toggle="collapse" href="#Parasites" role="button" aria-expanded="false" aria-controls="collapseExample">
                    l'animal est parasité
                </a>
                <div class="collapse" id="Parasites">
                    <div class="card card-body">
                        <textarea class="form-control col-md-12" id="animal-Intake.Parasites" name="Intake.Parasites" rows="5"></textarea>
                    </div>
                </div>

                <a class="btn btn-primary" name="Intake.RemarksBtn" data-toggle="collapse" href="#Remarks" role="button" aria-expanded="false" aria-controls="collapseExample">
                    Remarques
                </a>
                <div class="collapse" id="Remarks">
                    <div class="card card-body">
                        <textarea class="form-control col-md-12" id="animal-Intake.Parasites" name="Intake.Remarks" rows="5"></textarea>
                    </div>
                </div>
                </div>

                <button class="btn btn-primary prevBtn btn-lg pull-right" type="button" >Précedent</button>
                <button class="btn btn-success btn-lg pull-right" type="submit">Terminer!</button>
            </div>
        </div>
    </div>
</div>
<% } %>


<script type="text/javascript">
$( document ).ready(function(){
    window.setupWizard();
})
</script>
